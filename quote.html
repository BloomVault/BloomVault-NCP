<!doctype html>
<html lang="en"><head>
  <title>Get a Quote · BloomVault Farms</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/overrides.css">
</head>
<body>
<div class="wrapper">
  
  <div class="sidebar">
    <div class="brand"><img src="assets/img/logo.png" alt="BloomVault Farms"></div>
    <nav class="tabs">
      <a class="tab" href="index.html">Home</a>
      <a class="tab" href="catalogue.html">Strain Catalogue</a>
      <a class="tab" href="quote.html">Get a Quote</a>
      <a class="tab" href="contact.html">Contact Us</a>
    </nav>
    <div class="badge small">Serving Virginia commercial growers only</div>
  </div>

  <main class="main">
    <section class="card">
      <h1>Your Quote</h1>

      <div class="grid">
        <!-- Cart (left column) -->
        <div class="card cart">
          <h3>Cart</h3>
          <section id="quote-cart"></section>
          <div class="notice" style="margin-top:10px">
            Orders are at a <b>50 plant minimum</b>. Quantities reflect how many times you pressed
            “<b>Add to Quote +1</b>” in the catalogue (1 = 50, 2 = 100, etc.).
          </div>
        </div>

        <!-- Request form (right column) -->
        <div class="card">
          <h3>Request a Quote</h3>
          <form id="quote-form" name="quote" method="POST" data-netlify="true" netlify-honeypot="bot-field">
            <input type="hidden" name="form-name" value="quote">

            <!-- Honeypot (off-screen) -->
            <div class="hp" aria-hidden="true" tabindex="-1">
              <label>Don’t fill this out:
                <input type="text" name="bot-field" autocomplete="off">
              </label>
            </div>

            <!-- Time-on-form (ms) -->
            <input type="hidden" name="submit_ms" value="0">

            <div class="form-row">
              <input class="input" name="businessName" placeholder="Legal Business Name*" required>
              <input class="input" name="contactName" placeholder="Contact Name*" required>
            </div>
            <div class="form-row">
              <input class="input" name="email" type="email" placeholder="Email*" required>
              <input class="input" name="phone" placeholder="Phone*" required>
            </div>
            <div class="form-row">
              <input class="input" name="street" placeholder="Business Street Address (Virginia)*" required>
              <input class="input" name="city" placeholder="City*" required>
            </div>
            <div class="form-row">
              <input class="input" name="state" value="VA" required>
              <input class="input" name="zip" placeholder="ZIP*" required>
            </div>
            <div class="form-row">
              <input class="input" name="license" placeholder="VA Hemp License # or 'Pending'*" required>
              <input class="input" name="resale" placeholder="Resale certificate (optional)">
            </div>
            <textarea class="input" name="notes" rows="4" placeholder="Notes (optional)"></textarea>
            <div class="notice" style="margin-top:10px">Currently serving <b>commercial growers in Virginia</b> only.</div>

            <!-- Hidden cart payloads (kept in sync by script) -->
            <input type="hidden" name="cart" value="[]">
            <input type="hidden" name="cart_readable" value="">

            <!-- Human check -->
            <label for="human-check" class="small" style="display:flex;gap:.5rem;align-items:center;margin-top:.6rem">
              <input type="checkbox" id="human-check" name="human_check" value="1" required>
              <span>I am human (no bots)</span>
            </label>

            <button class="btn" type="submit" id="quote-submit" style="margin-top:12px">Request Quote</button>
            <div class="small" id="quote-result" style="margin-top:8px"></div>
          </form>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Optional: keep your modules if used elsewhere -->
<script type="module" src="assets/js/cart.js"></script>
<script type="module" src="assets/js/quote.js"></script>

<!-- Cart render (no sliders) + per-row "Remove -1" + hidden fields sync -->
<script>
(function () {
  const STORAGE_KEY = "quoteCart";
  const mount = document.getElementById("quote-cart");

  // Hidden fields for form submit
  const form = document.getElementById("quote-form") || document.querySelector("form") || document.body;
  const hiddenJson = form.querySelector('input[name="cart"]');
  const hiddenReadable = form.querySelector('input[name="cart_readable"]');

  function readCart() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch (e) { return []; }
  }
  function updateHidden(items) {
    if (hiddenJson) hiddenJson.value = JSON.stringify(items);

    // Human-friendly summary for emails
    if (hiddenReadable) {
      if (!items.length) {
        hiddenReadable.value = "Cart: (empty)";
      } else {
        const lines = items.map(it => {
          const qty = it.qty || 0;
          const plants = qty * 50;
          return `${it.name} × ${qty} (${plants} plants)`;
        });
        const totalPlants = items.reduce((n, it) => n + (it.qty || 0) * 50, 0);
        hiddenReadable.value = `Cart:\n${lines.join("\\n")}\nTotal plants: ${totalPlants}`;
      }
    }
  }
  function writeCart(cart) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
    updateHidden(cart);
  }

  // Support old ?add=Name links: add one, then clean the URL once
  (function prefillFromQuery() {
    const params = new URLSearchParams(location.search);
    const add = params.get("add");
    if (!add) return;
    let cart = readCart();
    const i = cart.findIndex(it => it.name === add);
    if (i >= 0) cart[i].qty = (cart[i].qty || 0) + 1;
    else cart.push({ id: add, name: add, qty: 1 });
    writeCart(cart);
    params.delete("add");
    const url = location.pathname + (params.toString() ? "?" + params.toString() : "");
    history.replaceState({}, "", url);
  })();

  function decOne(id, name) {
    const cart = readCart();
    const i = cart.findIndex(it => String(it.id) === String(id) && it.name === name);
    if (i >= 0) {
      const next = (cart[i].qty || 0) - 1;
      if (next <= 0) cart.splice(i, 1);
      else cart[i].qty = next;
      writeCart(cart);
    }
  }

  function render() {
    const items = readCart();
    updateHidden(items);

    if (!items.length) {
      mount.innerHTML = '<p class="small">Your cart is empty. Go back to the <a href="catalogue.html">catalogue</a> to add strains.</p>';
      return;
    }

    const rows = items.map(it => `
      <tr data-id="${it.id}" data-name="${it.name}">
        <td>${it.name}</td>
        <td style="text-align:right">${it.qty || 0}</td>
        <td style="text-align:right">
          <button type="button" class="btn remove-one">Remove -1</button>
        </td>
      </tr>
    `).join("");

    mount.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Strain</th>
            <th style="text-align:right">Qty</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p class="small">Click “Remove -1” to decrease quantity. When an item reaches 0 it disappears.</p>
    `;
  }

  // Click handler for Remove -1
  mount.addEventListener("click", (e) => {
    const btn = e.target.closest(".remove-one");
    if (!btn) return;
    const tr = btn.closest("tr");
    const id = tr.getAttribute("data-id");
    const name = tr.getAttribute("data-name");
    decOne(id, name);
    render();
  });

  // Initial render + refresh if user returns from catalogue
  render();
  window.addEventListener("focus", render);
})();
</script>

<!-- Anti-spam: human checkbox + submitted-too-fast check -->
<script>
(function () {
  const form = document.getElementById("quote-form");
  const submitBtn = document.getElementById("quote-submit");
  const result = document.getElementById("quote-result");
  const msField = form.querySelector('input[name="submit_ms"]');
  const human = form.querySelector('#human-check');
  const START = Date.now();
  const MIN_MS = 4000; // require at least 4s on the page

  form.addEventListener("submit", function (e) {
    const elapsed = Date.now() - START;
    if (msField) msField.value = String(elapsed);

    // Require human checkbox
    if (human && !human.checked) {
      e.preventDefault();
      if (result) result.textContent = "Please confirm you're human.";
      human.focus();
      return;
    }

    // Minimum time-on-form
    if (elapsed < MIN_MS) {
      e.preventDefault();
      if (submitBtn) submitBtn.disabled = true;
      if (result) result.textContent = "Please take a moment to complete the form before submitting.";
      setTimeout(() => {
        if (submitBtn) submitBtn.disabled = false;
        if (result) result.textContent = "";
      }, Math.max(1500, MIN_MS - elapsed));
    }
  });
})();
</script>

</body></html>
