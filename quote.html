<!doctype html>
<html lang="en"><head>
  <title>Get a Quote · BloomVault Farms</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/overrides.css">

  <!-- "SENT" bubble style (matches +1 look) -->
  <style>
    #quote-submit { position: relative; }
    .sent-bubble {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translate(-50%, 6px) scale(.9);
      font-size: 12px;
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      background: linear-gradient(#caa95a,#b58c2b);
      color: #111;
      border: 1px solid #8b6b18;
      padding: 2px 8px;
      border-radius: 9999px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,.25);
      animation: popFade .85s ease-out forwards;
    }
    @keyframes popFade {
      0%   { opacity: 0; transform: translate(-50%, 6px) scale(.9); }
      20%  { opacity: 1; transform: translate(-50%, 0) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -8px) scale(1); }
    }
  </style>
</head>
<body>
<div class="wrapper">
  
  <div class="sidebar">
    <div class="brand"><img src="assets/img/logo.png" alt="BloomVault Farms"></div>
    <nav class="tabs">
      <a class="tab" href="index.html">Home</a>
      <a class="tab" href="catalogue.html">Strain Catalogue</a>
      <a class="tab" href="quote.html">Get a Quote</a>
      <a class="tab" href="contact.html">Contact Us</a>
    </nav>
    <div class="badge small">Serving Virginia commercial growers only</div>
  </div>

  <main class="main">
    <section class="card">
      <h1>Your Quote</h1>

      <div class="grid">
        <!-- Cart (left column) -->
        <div class="card cart">
          <h3>Cart</h3>
          <section id="quote-cart"></section>
          <div class="notice" style="margin-top:10px">
            Orders are at a <b>50 plant minimum</b>. Quantities reflect how many times you pressed
            “<b>Add to Quote +1</b>” in the catalogue (1 = 50, 2 = 100, etc.).
          </div>
        </div>

        <!-- Request form (right column) -->
        <div class="card">
          <h3>Request a Quote</h3>
          <form id="quote-form" name="quote" method="POST">
            <!-- Honeypot (off-screen) -->
            <div class="hp" aria-hidden="true" tabindex="-1">
              <label>Don’t fill this out:
                <input type="text" name="bot-field" autocomplete="off">
              </label>
            </div>

            <!-- Time-on-form (ms) -->
            <input type="hidden" name="submit_ms" value="0">

            <div class="form-row">
              <input class="input" name="businessName" placeholder="Legal Business Name*" required>
              <input class="input" name="contactName" placeholder="Contact Name*" required>
            </div>
            <div class="form-row">
              <input class="input" name="email" type="email" placeholder="Email*" required>
              <input class="input" name="phone" placeholder="Phone*" required>
            </div>
            <div class="form-row">
              <input class="input" name="street" placeholder="Business Street Address (Virginia)*" required>
              <input class="input" name="city" placeholder="City*" required>
            </div>
            <div class="form-row">
              <input class="input" name="state" value="VA" required>
              <input class="input" name="zip" placeholder="ZIP*" required>
            </div>
            <div class="form-row">
              <input class="input" name="license" placeholder="VA Hemp License # or 'Pending'*" required>
              <input class="input" name="resale" placeholder="Resale certificate (optional)">
            </div>
            <textarea class="input" name="notes" rows="4" placeholder="Notes (optional)"></textarea>
            <div class="notice" style="margin-top:10px">Currently serving <b>commercial growers in Virginia</b> only.</div>

            <!-- Hidden cart payloads (kept in sync by script) -->
            <input type="hidden" name="cart" value="[]">
            <input type="hidden" name="cart_readable" value="">

            <!-- Human check -->
            <label for="human-check" class="small" style="display:flex;gap:.5rem;align-items:center;margin-top:.6rem">
              <input type="checkbox" id="human-check" name="human_check" value="1" required>
              <span>I am human (no bots)</span>
            </label>

            <button class="btn" type="submit" id="quote-submit" style="margin-top:12px">Request Quote</button>
            <div class="small" id="quote-result" style="margin-top:8px"></div>
          </form>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Keep cart.js if needed elsewhere -->
<script type="module" src="assets/js/cart.js"></script>
<!-- REMOVED: old mailto handler -->
<!-- <script type="module" src="assets/js/quote.js"></script> -->

<!-- Cart render (no sliders) + per-row "Remove -1" + hidden fields sync -->
<script>
(function () {
  const STORAGE_KEY = "quoteCart";
  const mount = document.getElementById("quote-cart");

  // Hidden fields for form submit
  const form = document.getElementById("quote-form") || document.querySelector("form") || document.body;
  const hiddenJson = form.querySelector('input[name="cart"]');
  const hiddenReadable = form.querySelector('input[name="cart_readable"]');

  function readCart() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch (e) { return []; }
  }
  function updateHidden(items) {
    if (hiddenJson) hiddenJson.value = JSON.stringify(items);

    // Human-friendly summary for emails
    if (hiddenReadable) {
      if (!items.length) {
        hiddenReadable.value = "Cart: (empty)";
      } else {
        const lines = items.map(it => {
          const qty = it.qty || 0;
          const plants = qty * 50;
          return `${it.name} × ${qty} (${plants} plants)`;
        });
        const totalPlants = items.reduce((n, it) => n + (it.qty || 0) * 50, 0);
        hiddenReadable.value = `Cart:\n${lines.join("\n")}\nTotal plants: ${totalPlants}`;
      }
    }
  }
  function writeCart(cart) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
    updateHidden(cart);
  }

  // Support old ?add=Name links: add one, then clean the URL once
  (function prefillFromQuery() {
    const params = new URLSearchParams(location.search);
    const add = params.get("add");
    if (!add) return;
    let cart = readCart();
    const i = cart.findIndex(it => it.name === add);
    if (i >= 0) cart[i].qty = (cart[i].qty || 0) + 1;
    else cart.push({ id: add, name: add, qty: 1 });
    writeCart(cart);
    params.delete("add");
    const url = location.pathname + (params.toString() ? "?" + params.toString() : "");
    history.replaceState({}, "", url);
  })();

  function decOne(id, name) {
    const cart = readCart();
    const i = cart.findIndex(it => String(it.id) === String(id) && it.name === name);
    if (i >= 0) {
      const next = (cart[i].qty || 0) - 1;
      if (next <= 0) cart.splice(i, 1);
      else cart[i].qty = next;
      writeCart(cart);
    }
  }

  function render() {
    const items = readCart();
    updateHidden(items);

    if (!items.length) {
      mount.innerHTML = ''; // no default message when empty
      return;
    }

    const rows = items.map(it => `
      <tr data-id="${it.id}" data-name="${it.name}">
        <td>${it.name}</td>
        <td style="text-align:right">${it.qty || 0}</td>
        <td style="text-align:right">
          <button type="button" class="btn remove-one">Remove -1</button>
        </td>
      </tr>
    `).join("");

    mount.innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>Strain</th>
            <th style="text-align:right">Qty</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p class="small">Click “Remove -1” to decrease quantity. When an item reaches 0 it disappears.</p>
    `;
  }

  // Click handler for Remove -1
  mount.addEventListener("click", (e) => {
    const btn = e.target.closest(".remove-one");
    if (!btn) return;
    const tr = btn.closest("tr");
    const id = tr.getAttribute("data-id");
    const name = tr.getAttribute("data-name");
    decOne(id, name);
    render();
  });

  // Initial render + refresh if user returns from catalogue
  render();
  window.addEventListener("focus", render);
})();
</script>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<!-- Anti-spam + EmailJS submit (no redirect) + success reset + SENT bubble -->
<script>
(function () {
  const STORAGE_KEY = "quoteCart";
  const form = document.getElementById("quote-form");
  const submitBtn = document.getElementById("quote-submit");
  const result = document.getElementById("quote-result");
  const msField = form.querySelector('input[name="submit_ms"]');
  const human = form.querySelector('#human-check');

  /* ====== EmailJS values (filled) ====== */
  const EMAILJS_PUBLIC_KEY = "Iph-DFQJujXfJ_gni";
  const EMAILJS_SERVICE_ID = "service_5n04n5s";
  const EMAILJS_TEMPLATE_ID = "template_sujzntx";
  /* ===================================== */

  // init EmailJS
  emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

  const START = Date.now();
  const MIN_MS = 4000; // require at least 4s on the page

  function readCart() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch (e) { return []; }
  }
  function cartReadable(items) {
    if (!items.length) return "Cart: (empty)";
    const lines = items.map(it => {
      const qty = it.qty || 0;
      const plants = qty * 50;
      return `${it.name} × ${qty} (${plants} plants)`;
    });
    const totalPlants = items.reduce((n, it) => n + (it.qty || 0) * 50, 0);
    return `Cart:\n${lines.join("\n")}\nTotal plants: ${totalPlants}`;
  }

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation(); // ensure no other handler runs

    // time-on-form & human checks
    const elapsed = Date.now() - START;
    if (msField) msField.value = String(elapsed);

    if (human && !human.checked) {
      result.textContent = "Please confirm you're human.";
      human.focus();
      return;
    }
    if (elapsed < MIN_MS) {
      submitBtn.disabled = true;
      result.textContent = "Please take a moment to complete the form before submitting.";
      await new Promise(r => setTimeout(r, Math.max(1500, MIN_MS - elapsed)));
      submitBtn.disabled = false;
      result.textContent = "";
      return;
    }

    // Only show empty-cart message on submit
    const items = readCart();
    if (!items.length) {
      result.textContent = "Your cart is empty. Please add strains from the catalogue first.";
      document.querySelector(".card.cart")?.scrollIntoView({ behavior: "smooth", block: "start" });
      return;
    }

    const fd = new FormData(form);

    // Honeypot
    if (fd.get("bot-field")) {
      result.textContent = "Submission blocked.";
      return;
    }

    // Build payload for EmailJS
    const payload = {
      to_email: "bloomvaultfarms@gmail.com",
      submitted_at: new Date().toLocaleString(),
      submit_ms: fd.get("submit_ms") || "",
      from_name: fd.get("contactName") || "",
      from_email: fd.get("email") || "",
      phone: fd.get("phone") || "",
      businessName: fd.get("businessName") || "",
      street: fd.get("street") || "",
      city: fd.get("city") || "",
      state: fd.get("state") || "",
      zip: fd.get("zip") || "",
      license: fd.get("license") || "",
      resale: fd.get("resale") || "",
      notes: fd.get("notes") || "",
      cart_readable: cartReadable(items),
      cart_json: JSON.stringify(items)
    };

    try {
      submitBtn.disabled = true;
      result.textContent = "Sending your request…";
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, payload);

      // Success: clear + hide cart panel, reset form, show success + "SENT" bubble
      localStorage.removeItem(STORAGE_KEY);
      form.reset();
      result.textContent = "Thanks! Your quote request has been sent. We’ll be in touch soon.";
      const cartCard = document.querySelector(".card.cart");
      if (cartCard) cartCard.style.display = "none";

      const tag = document.createElement("span");
      tag.className = "sent-bubble";
      tag.textContent = "SENT";
      submitBtn.appendChild(tag);
      setTimeout(() => tag.remove(), 900);
    } catch (err) {
      console.error(err);
      result.textContent = "Sorry—couldn’t send just now. Please try again.";
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>

</body></html>
